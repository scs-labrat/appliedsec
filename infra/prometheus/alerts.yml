groups:
  - name: aluskort.rules
    rules:
      # LLM Circuit Breaker
      - alert: AluskortLLMCircuitBreakerOpen
        expr: 'aluskort_llm_circuit_breaker_state{state="open"} == 1'
        for: 1m
        labels:
          severity: critical
          component: context-gateway
        annotations:
          summary: "LLM circuit breaker is OPEN"
          description: >
            The Anthropic API circuit breaker has opened. ALUSKORT is operating
            in deterministic-only mode. Verify Anthropic API status and check
            degradation mode.

      # Kafka Consumer Lag — Warning
      - alert: AluskortKafkaConsumerLagHigh
        expr: aluskort_kafka_consumer_lag > 1000
        for: 5m
        labels:
          severity: warning
          component: kafka
        annotations:
          summary: "Kafka consumer lag exceeds 1000 messages"
          description: >
            Consumer lag on topic {{ $labels.topic }} partition
            {{ $labels.partition }} for group {{ $labels.consumer_group }}
            has exceeded 1000 messages for 5 minutes.

      # Kafka Consumer Lag — Critical
      - alert: AluskortKafkaConsumerLagCritical
        expr: aluskort_kafka_consumer_lag > 10000
        for: 5m
        labels:
          severity: critical
          component: kafka
        annotations:
          summary: "Kafka consumer lag exceeds 10000 messages"
          description: >
            Consumer lag on topic {{ $labels.topic }} has exceeded 10000
            messages. Immediate investigation required.

      # Stuck Investigation
      - alert: AluskortInvestigationStuck
        expr: >
          aluskort_investigations_by_state{state="awaiting_human"} > 0
          and time() - aluskort_investigation_awaiting_human_since > 10800
        for: 5m
        labels:
          severity: critical
          component: orchestrator
        annotations:
          summary: "Investigation stuck in AWAITING_HUMAN > 3 hours"
          description: >
            An investigation has been in AWAITING_HUMAN state for over
            3 hours. The SOC lead should review pending approval actions.

      # Monthly Spend — Soft Limit
      - alert: AluskortMonthlySpendSoftLimit
        expr: aluskort_llm_cost_usd_total > 500
        for: 1m
        labels:
          severity: warning
          component: context-gateway
        annotations:
          summary: "Monthly API spend exceeds $500 soft limit"
          description: >
            Monthly Anthropic API spend has exceeded the $500 soft limit.
            Current spend: ${{ $value }}.

      # Monthly Spend — Hard Cap
      - alert: AluskortMonthlySpendHardCap
        expr: aluskort_llm_cost_usd_total > 1000
        for: 1m
        labels:
          severity: critical
          component: context-gateway
        annotations:
          summary: "Monthly API spend exceeds $1000 hard cap"
          description: >
            Monthly Anthropic API spend has exceeded the $1000 hard cap.
            New LLM calls will be rejected. Immediate action required.

      # Batch SLA Breach
      - alert: AluskortBatchSLABreach
        expr: aluskort_batch_sla_breaches_total > 0
        for: 1m
        labels:
          severity: warning
          component: batch-scheduler
        annotations:
          summary: "Batch job breached 24-hour SLA"
          description: >
            One or more batch jobs have exceeded the 24-hour SLA.

      # Detection Rules Stopped
      - alert: AluskortDetectionRuleFailure
        expr: rate(aluskort_detection_rules_evaluated_total[5m]) == 0
        for: 15m
        labels:
          severity: warning
          component: atlas-detection
        annotations:
          summary: "Detection rules stopped evaluating"
          description: >
            No detection rule evaluations in the last 15 minutes.
            The detection runner may have stopped or crashed.
